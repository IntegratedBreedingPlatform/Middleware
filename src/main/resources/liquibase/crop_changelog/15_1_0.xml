<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="gelli" id="v15.1.0-1">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT
				if(DATA_TYPE = 'varchar' and CHARACTER_MAXIMUM_LENGTH = 255, 1, 0) as new_datatype
				FROM  INFORMATION_SCHEMA.COLUMNS
				WHERE table_name='key_sequence_register'
				AND column_name='key_prefix'
				AND TABLE_SCHEMA = database();
			</sqlCheck>
		</preConditions>
		<comment>Alter key_prefix data type from varchar(50) to varchar(255)</comment>
		<modifyDataType tableName="key_sequence_register" columnName="key_prefix" newDataType="varchar(255)"/>
	</changeSet>

	<changeSet author="mderamos" id="v15.1.0-2">
		<preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					SELECT COUNT(*) from nd_experiment means_exp
						INNER JOIN project means ON means.project_id = means_exp.project_id AND means.dataset_type_id = 2
						INNER JOIN project plot ON plot.study_id = means.study_id AND plot.dataset_type_id = 4
						INNER JOIN nd_experiment plot_exp ON plot_exp.project_id = plot.project_id
						INNER JOIN stock means_stock ON means_stock.stock_id = means_exp.stock_id
						INNER JOIN stock plot_stock ON plot_stock.stock_id = plot_exp.stock_id
						WHERE means_stock.uniquename = plot_stock.uniquename AND means_exp.stock_id != plot_stock.stock_id;
				</sqlCheck>
			</not>
		</preConditions>
		<comment>Set stock_id of means experiments to use plot experiments stock_id and delete unnecessary stock entries</comment>
		<sql dbms="mysql">
			CREATE TEMPORARY TABLE means_stock_id AS
				SELECT DISTINCT means_exp.stock_id FROM nd_experiment means_exp
						INNER JOIN project means ON means.project_id = means_exp.project_id AND means.dataset_type_id = 2
						INNER JOIN project plot ON plot.study_id = means.study_id AND plot.dataset_type_id = 4
						INNER JOIN nd_experiment plot_exp ON plot_exp.project_id = plot.project_id
						INNER JOIN stock means_stock ON means_stock.stock_id = means_exp.stock_id
						INNER JOIN stock plot_stock ON plot_stock.stock_id = plot_exp.stock_id
						WHERE means_stock.uniquename = plot_stock.uniquename AND means_exp.stock_id != plot_stock.stock_id;


			UPDATE nd_experiment means_exp
				INNER JOIN project means ON means.project_id = means_exp.project_id AND means.dataset_type_id = 2
				INNER JOIN project plot ON plot.study_id = means.study_id AND plot.dataset_type_id = 4
				INNER JOIN nd_experiment plot_exp ON plot_exp.project_id = plot.project_id
				INNER JOIN stock means_stock ON means_stock.stock_id = means_exp.stock_id
				INNER JOIN stock plot_stock ON plot_stock.stock_id = plot_exp.stock_id
				SET means_exp.stock_id = plot_stock.stock_id
				WHERE means_stock.uniquename = plot_stock.uniquename AND means_exp.stock_id != plot_stock.stock_id;

			DELETE FROM stock
				WHERE stock_id IN (
				  SELECT stock_id
				  FROM means_stock_id
				);
		</sql>
	</changeSet>

</databaseChangeLog>
