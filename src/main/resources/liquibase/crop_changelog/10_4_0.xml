<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">


	<changeSet author="marie" id="v10.4.0-1">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) 
				FROM location
				WHERE labbr = 'NOLOC';
			</sqlCheck>
		</preConditions>
		<comment>Unspecified location should be defined as Breeding Location</comment>
		<sql dbms="mysql" splitStatements="true">
			UPDATE location
			SET ltype=410 
			WHERE labbr = 'NOLOC';
		</sql>
	</changeSet>

	<changeSet author="marie" id="v10.4.0-2">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT COUNT(*) 
				FROM location
				WHERE labbr = 'NOLOC';
			</sqlCheck>
		</preConditions>
		<comment>Unspecified location should be favorite location for all existing programs</comment>
		<sql dbms="mysql" splitStatements="true">
			
			DECLARE uuid TEXT(36);
			DECLARE done INT DEFAULT FALSE;

			DECLARE CUR1 CURSOR FOR
				SELECT program_uuid FROM project;
			
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

			SELECT @unspecifiedLocID:=locid
				FROM location
				WHERE labbr = 'NOLOC';

			OPEN CUR1;
		    read_loop: LOOP FETCH CUR1 INTO uuid;
		    	IF done THEN
					LEAVE read_loop;
				END IF;

				INSERT INTO program_favorites 
					( entity_type, entity_id, program_uuid)
				VALUES 
					("LOCATION", @unspecifiedLocID, uuid);
		    END LOOP read_loop;

			CLOSE cur1;
				
		</sql>
	</changeSet>

	
</databaseChangeLog>
