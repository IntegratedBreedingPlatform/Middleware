<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="clarysabel" id="v17.3.0-1">
        <preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="external_reference"></tableExists>
			</not>
        </preConditions>
        <comment>
            Create external_reference table
        </comment>
   		<createTable tableName="external_reference">
           <column name="id" type="int" autoIncrement="true">
			   <constraints primaryKey="true"/>
		   </column>
		   <column name="gid" type="int">
           	   <constraints nullable="false" foreignKeyName="fk_external_reference_germplasm" references="germplsm(gid)"/>
           </column>
           <column name="reference_id" type="varchar(2000)">
			   <constraints nullable="false"/>
           </column>
           <column name="reference_source" type="varchar(255)">
			   <constraints nullable="false"/>
           </column>
       </createTable>
	</changeSet>

	<changeSet author="lkovacic" id="v17.3.0-2">
        <preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="atributs" columnName="created_by"/>
				<columnExists tableName="atributs" columnName="modified_by"/>
				<columnExists tableName="atributs" columnName="created_date"/>
				<columnExists tableName="atributs" columnName="modified_date"/>

				<columnExists tableName="bibrefs" columnName="created_by"/>
				<columnExists tableName="bibrefs" columnName="modified_by"/>
				<columnExists tableName="bibrefs" columnName="created_date"/>
				<columnExists tableName="bibrefs" columnName="modified_date"/>

				<columnExists tableName="germplsm" columnName="created_by"/>
				<columnExists tableName="germplsm" columnName="modified_by"/>
				<columnExists tableName="germplsm" columnName="created_date"/>
				<columnExists tableName="germplsm" columnName="modified_date"/>

				<columnExists tableName="names" columnName="created_by"/>
				<columnExists tableName="names" columnName="modified_by"/>
				<columnExists tableName="names" columnName="created_date"/>
				<columnExists tableName="names" columnName="modified_date"/>

				<columnExists tableName="progntrs" columnName="created_by"/>
				<columnExists tableName="progntrs" columnName="modified_by"/>
				<columnExists tableName="progntrs" columnName="created_date"/>
				<columnExists tableName="progntrs" columnName="modified_date"/>

				<columnExists tableName="external_reference" columnName="created_by"/>
				<columnExists tableName="external_reference" columnName="modified_by"/>
				<columnExists tableName="external_reference" columnName="created_date"/>
				<columnExists tableName="external_reference" columnName="modified_date"/>
			</not>
		</preConditions>
        <comment>
            Add fields for audit to tables: atributs, bibrefs, germplsm, names, progntrs and external_reference
        </comment>
        <sql dbms="mysql" splitStatements="true">

			ALTER TABLE atributs CHANGE auid created_by int default 0 not null;
			ALTER TABLE atributs ADD modified_by int null;
			ALTER TABLE atributs ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE atributs ADD modified_date timestamp null;

			ALTER TABLE bibrefs ADD created_by int default 0 not null;
			ALTER TABLE bibrefs ADD modified_by int null;
			ALTER TABLE bibrefs ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE bibrefs ADD modified_date timestamp null;

			ALTER TABLE germplsm CHANGE germuid created_by int default 0 not null;
			ALTER TABLE germplsm ADD modified_by int null;
			ALTER TABLE germplsm ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE germplsm ADD modified_date timestamp null;

			ALTER TABLE names CHANGE nuid created_by int default 0 not null;
			ALTER TABLE names ADD modified_by int null;
			ALTER TABLE names ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE names ADD modified_date timestamp null;

			ALTER TABLE progntrs ADD created_by int default 0 not null;
			ALTER TABLE progntrs ADD modified_by int null;
			ALTER TABLE progntrs ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE progntrs ADD modified_date timestamp null;

			ALTER TABLE external_reference ADD created_by int default 0 not null;
			ALTER TABLE external_reference ADD modified_by int null;
			ALTER TABLE external_reference ADD created_date timestamp default CURRENT_TIMESTAMP null;
			ALTER TABLE external_reference ADD modified_date timestamp null;

        </sql>
    </changeSet>

	<changeSet author="lkovacic" id="v17.3.0-3">
        <preConditions onFail="MARK_RAN">
			<and>
				<not>
					<tableExists tableName="revinfo"></tableExists>
					<tableExists tableName="atributs_aud"></tableExists>
					<tableExists tableName="bibrefs_aud"></tableExists>
					<tableExists tableName="germplasm_aud"></tableExists>
					<tableExists tableName="names_aud"></tableExists>
					<tableExists tableName="progntrs_aud"></tableExists>
					<tableExists tableName="external_reference_aud"></tableExists>
					<tableExists tableName="germplasm_externalreference_aud"></tableExists>
					<tableExists tableName="germplasm_name_aud"></tableExists>
				</not>
			</and>
		</preConditions>
        <comment>
            Create envers germplasm audit schema
        </comment>
        <sql dbms="mysql" splitStatements="true">
			CREATE TABLE revinfo (
				rev      int auto_increment
					primary key,
				revtstmp bigint null
			);

			CREATE TABLE atributs_aud (
				REV           int                      not null,
				REVTYPE       tinyint                  not null,
				aid           int                      not null,
				gid           int          default 0   not null,
				atype         int          default 0   not null,
				created_by    int          default 0   not null,
				aval          varchar(255) default '-' not null,
				alocn         int          default 0   null,
				aref          int          default 0   null,
				adate         int          default 0   null,
				modified_by   int                      null,
				created_date  timestamp                 null,
				modified_date timestamp                 null,
				primary key (aid, REV),
				constraint FK_atributs_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE bibrefs_aud (
				REV           int                      not null,
				REVTYPE       tinyint                  not null,
				refid         int                      not null,
				pubtype       int          default 0   null,
				pubdate       int          default 0   null,
				authors       varchar(100) default '-' not null,
				editors       varchar(100) default '-' not null,
				analyt        varchar(255) default '-' not null,
				monogr        varchar(255) default '-' not null,
				series        varchar(255) default '-' not null,
				volume        varchar(10)  default '-' not null,
				issue         varchar(10)  default '-' not null,
				pagecol       varchar(25)  default '-' not null,
				publish       varchar(50)  default '-' not null,
				pucity        varchar(30)  default '-' not null,
				pucntry       varchar(75)  default '-' not null,
				authorlist    int                      null,
				editorlist    int                      null,
				created_by    int          default 0   not null,
				modified_by   int                      null,
				created_date  timestamp                 null,
				modified_date timestamp                 null,
				primary key (refid, REV),
				constraint FK_bibrefs_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE germplsm_aud (
				REV           int                                    not null,
				REVTYPE       tinyint                                not null,
				gid           int                                    not null,
				methn         int                          default 0 not null,
				gnpgs         int                          default 0 not null,
				gpid1         int                          default 0 not null,
				gpid2         int                          default 0 not null,
				created_by    int                          default 0 not null,
				lgid          int                          default 0 not null,
				glocn         int                          default 0 not null,
				gdate         int                          default 0 not null,
				gref          int                          default 0 not null,
				grplce        int                          default 0 not null,
				mgid          int                          default 0 null,
				cid           int                                    null,
				sid           int                                    null,
				gchange       int                                    null,
				deleted       tinyint(1) unsigned zerofill default 0 null,
				germplsm_uuid varchar(60)                            null,
				modified_by   int                                    null,
				created_date  timestamp                               null,
				modified_date timestamp                               null,
				primary key (gid, REV),
				constraint FK_germplsm_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE names_aud (
				REV           int                      not null,
				REVTYPE       tinyint                  not null,
				nid           int                      not null,
				gid           int          default 0   not null,
				ntype         int          default 0   not null,
				nstat         int          default 0   not null,
				created_by    int          default 0   not null,
				nval          varchar(255) default '-' not null,
				nlocn         int          default 0   not null,
				ndate         int          default 0   not null,
				nref          int          default 0   not null,
				modified_by   int                      null,
				created_date  timestamp                 null,
				modified_date timestamp                 null,
				primary key (nid, REV),
				constraint FK_names_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE progntrs_aud (
				REV           int           not null,
				REVTYPE       tinyint       not null,
				gid           int default 0 not null,
				pno           int default 0 not null,
				pid           int default 0 not null,
				id            int           not null,
				created_by    int default 0 null,
				modified_by   int           null,
				created_date  timestamp     null,
				modified_date timestamp     null,
				primary key (id, REV),
				constraint FK_progntrs_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE external_reference_aud (
				REV              int           not null,
				REVTYPE          tinyint       not null,
				id               int           not null,
				gid              int           not null,
				reference_id     varchar(2000) not null,
				reference_source varchar(255)  not null,
				created_by       int default 0 not null,
				modified_by      int           null,
				created_date     timestamp     null,
				modified_date    timestamp     null,
				primary key (id, REV),
				constraint FK_external_reference_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE germplasm_externalreference_aud (
				REV     int     not null,
				REVTYPE tinyint not null,
				id      int     not null,
				gid     int     not null,
				primary key (id, gid, REV),
				constraint FK_germplasm_externalreference_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

			CREATE TABLE germplasm_name_aud (
				REV     int     not null,
				REVTYPE tinyint not null,
				nid     int     not null,
				gid     int     not null,
				primary key (nid, gid, REV),
				constraint FK_germplasm_name_aud_revinfo
					foreign key (REV) references revinfo(rev)
			);

        </sql>
    </changeSet>

</databaseChangeLog>
