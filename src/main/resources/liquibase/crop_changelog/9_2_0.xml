<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

	<changeSet author="clarissa" id="v9.2.0-1">
		<preConditions onFail="MARK_RAN">
			<columnExists tableName="project" columnName="created_by"/>
		</preConditions>
		<comment>
			Assign project.created_by = admin user id for nursery, trial templates. Jira IBP-1655 
		</comment>
		<sql dbms="mysql" splitStatements="true">
			UPDATE project p SET p.created_by =  
				(SELECT userid FROM users WHERE uname='admin')
			WHERE NAME LIKE '%template' AND program_uuid IS NULL;
		</sql>
	</changeSet>
	<changeSet author="clarissa" id="v9.2.0-2">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">select case when ('ibdbv2_bean_merged' = DATABASE()) then 1 else 0 end from dual;</sqlCheck>
		</preConditions>
		<comment>
			Apply fix on bean template and reduce the number of traits.
		</comment>
		<sql dbms="mysql" splitStatements="true">
			UPDATE projectprop SET type_id = 1804 WHERE type_id = 1042;
			
			DELETE FROM projectprop WHERE project_id = 3510 AND rank IN 
			(10,17,22,23,24,25,26,27,28,29,31,32,33,34,35,39,40,46,47,48,49,
			51,53,54,55,59,60,61,64,65,66,68,69,70,71,73,77,78,80,82,83,89,
			90,91,92,93,94,95,97,101,102,104,105,109,110,111,112,113,114,115,
			116,119,120,121,122,126,127,130,132,134,135,136,138,139,140,
			141,144,145,150,151,152,156,157,158,159,160,163,164,174,175,
			176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,
			191,192,193,194,195,197,199,201,203,204,205,206,207,208,209,210,
			211,212,213,214,215,216,221,222,223,224,225,227,228);
			
		</sql>
	</changeSet>

	<changeSet author="aldrin" id="v9.2.0-3">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="0">
				<![CDATA[Select count(*) from `location` Where lname = 'Unspecified Location';]]>
			</sqlCheck>
		</preConditions>
		<comment>Automatically add location name ([8190] LOCATION_ID variable) to existing studies.</comment>
		<sql dbms="mysql">
			<![CDATA[
			-- FOR TRIAL STUDIES

			INSERT INTO `location` (`ltype`, `nllp`, `lname`, `labbr`, `snl3id`, `snl2id`, `snl1id`, `cntryid`, `lrplce`, `nnpid`)
			Values ('405', '1', 'Unspecified Location', 'NOLOC', '0', '0', '0', '0', '0', '0');

			-- Create LOCATION_ID variable entries in ENVIRONMENT (SUMMARY) DATASET

			Insert into projectprop (project_id, type_id, value, rank, variable_id, alias)
			Select project.project_id,
			1806,
			(Select locid from location where lname = 'Unspecified Location'),
			case when max(projectpropRank.rank) is null then 1 else max(projectpropRank.rank) + 1 end as rank,
			8190,
			'LOCATION_NAME'
			from project
			inner join projectprop projectprop_dataset on projectprop_dataset.project_id = project.project_id and projectprop_dataset.variable_id = 8160 and projectprop_dataset.value = 10080
			inner join project_relationship on project.project_id = project_relationship.subject_project_id
			inner join project projectTrial on projectTrial.project_id = project_relationship.object_project_id
			left join projectprop on project.project_id = projectprop.project_id and projectprop.variable_id = 8190
			left join projectprop projectpropRank on project.project_id = projectpropRank.project_id
			where projectTrial.study_type = 'T' and projectTrial.name <> 'Basic Trial Template' and projectprop.variable_id is null
			group by project_id;

			-- Create LOCATION_ID variable entries at INSTANCE/ENVIRONMENT level

			Insert into nd_geolocationprop (nd_geolocation_id, type_id, value, rank)
			SELECT
			nd_geolocation.nd_geolocation_id,
			8190,
			case when  projectprop_study.value is not null and projectprop_study.value <> '' then projectprop_study.value else (Select locid from location where lname = 'Unspecified Location') end,
			case when max(gpRank.rank) is null then 1 else max(gpRank.rank) + 1 end as rank
			from project
			inner join projectprop projectprop_dataset on projectprop_dataset.project_id = project.project_id and projectprop_dataset.variable_id = 8160 and projectprop_dataset.value = 10080
			inner join project_relationship on project.project_id = project_relationship.subject_project_id
			inner join project projectTrial on projectTrial.project_id = project_relationship.object_project_id
			inner join nd_experiment_project on project.project_id = nd_experiment_project.project_id
			inner join nd_experiment on nd_experiment.nd_experiment_id = nd_experiment_project.nd_experiment_id
			inner join nd_geolocation on nd_geolocation.nd_geolocation_id = nd_experiment.nd_geolocation_id
			left join nd_geolocationprop on nd_geolocationprop.nd_geolocation_id = nd_geolocation.nd_geolocation_id and nd_geolocationprop.type_id = 8190
			left join nd_geolocationprop gpRank on gpRank.nd_geolocation_id = nd_geolocation.nd_geolocation_id
            left join projectprop projectprop_study on projectprop_study.project_id = projectTrial.project_id and projectprop_study.variable_id = 8190
			where projectTrial.study_type = 'T' and projectTrial.name <> 'Basic Trial Template' and nd_geolocationprop.type_id is null
			group by nd_geolocation_id;

			-- Update LOCATION_ID variable's value to 'Unspecified Location' if the existing variables have no value

			Update nd_geolocationprop set nd_geolocationprop.value = (Select locid from location where lname = 'Unspecified Location')
			where nd_geolocationprop.type_id = 8190 and  nd_geolocationprop.type_id is not null and (nd_geolocationprop.value = '' or nd_geolocationprop.value is null);

			-- Preserve the alias of location name

            Update projectprop
            inner join project on project.project_id = projectprop.project_id
			inner join projectprop projectprop_dataset on projectprop_dataset.project_id = project.project_id and projectprop_dataset.variable_id = 8160 and projectprop_dataset.value = 10080
			inner join project_relationship on project.project_id = project_relationship.subject_project_id
			inner join project projectTrial on projectTrial.project_id = project_relationship.object_project_id
            left join projectprop projectprop_location_name on project.project_id = projectprop_location_name.project_id and projectprop_location_name.variable_id = 8180
			set projectprop.alias = Case when projectprop_location_name.alias is null Then 'LOCATION_NAME' else projectprop_location_name.alias END
            where projectprop.variable_id = 8190 and projectTrial.study_type = 'T' and projectTrial.name <> 'Basic Trial Template';

			-- Delete LOCATION_NAME variable at ENVIRONMENT DETAILS (Instance Level)

			Delete projectprop from project
			inner join projectprop projectprop_dataset on projectprop_dataset.project_id = project.project_id and projectprop_dataset.variable_id = 8160 and projectprop_dataset.value = 10080
			inner join project_relationship on project.project_id = project_relationship.subject_project_id
			inner join project projectTrial on projectTrial.project_id = project_relationship.object_project_id
			left join projectprop on project.project_id = projectprop.project_id and projectprop.variable_id = 8180
			where projectTrial.study_type = 'T' and projectTrial.name <> 'Basic Trial Template';

			Delete FROM nd_geolocationprop where type_id = 8180;

			-- Delete LOCATION_NAME/ID variables at TRIAL SETTINGS (Study Level)

			Delete projectprop from project
			inner join projectprop projectprop_dataset on projectprop_dataset.project_id = project.project_id and projectprop_dataset.variable_id = 8160 and projectprop_dataset.value = 10080
			inner join project_relationship on project.project_id = project_relationship.subject_project_id
			inner join project projectTrial on projectTrial.project_id = project_relationship.object_project_id
			left join projectprop on projectTrial.project_id = projectprop.project_id and (projectprop.variable_id = 8180 or projectprop.variable_id = 8190)
			where projectTrial.study_type = 'T' and projectTrial.name <> 'Basic Trial Template';

			-- FOR NURSERY STUDIES

			# Create LOCATION_ID variable entries in STUDY DATASET

			Insert into projectprop (project_id, type_id, value, rank, variable_id, alias)
			Select project.project_id,
			1805,
			(Select locid from location where lname = 'Unspecified Location'),
			case when max(projectpropRank.rank) is null then 1 else max(projectpropRank.rank) + 1 end as rank,
			8190,
			'LOCATION_NAME'
			from project
			left join projectprop on projectprop.project_id = project.project_id and projectprop.variable_id = 8190
			left join projectprop projectpropRank on project.project_id = projectpropRank.project_id
			where project.study_type = 'N' and name <> 'Basic nursery template' and projectprop.variable_id is null
			group by project_id;

			-- Update LOCATION_ID variable's value to 'Unspecified Location' if the existing variables have no value
            -- Preserve the alias of location name

			Update projectprop
			inner join project on project.project_id = projectprop.project_id
            left join projectprop projectprop_location_name on project.project_id = projectprop_location_name.project_id and projectprop_location_name.variable_id = 8180
			set projectprop.value = (Select locid from location where lname = 'Unspecified Location'),
            projectprop.alias = Case when projectprop_location_name.alias is null Then 'LOCATION_NAME' else projectprop_location_name.alias END
			where projectprop.variable_id = 8190 and (projectprop.value is null or projectprop.value = '')
			and project.study_type = 'N' and name <> 'Basic nursery template';

			-- Delete LOCATION_NAME variable in all Nursery Studies

			Delete projectprop from projectprop
			inner join project on projectprop.project_id = project.project_id and projectprop.variable_id = 8180
			where project.study_type = 'N' and name <> 'Basic nursery template';
			]]>
		</sql>
	</changeSet>

</databaseChangeLog>
