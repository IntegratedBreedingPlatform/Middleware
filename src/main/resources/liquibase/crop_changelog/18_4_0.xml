<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="darla" id="v18.4.0-1">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="0">
					SELECT COUNT(1) FROM udflds where ftable = 'NAMES' AND ftype = 'NAME' and fcode = 'PUI';
				</sqlCheck>
				<sqlCheck expectedResult="0">
					SELECT COUNT(1) FROM udflds where fldno = 40;
				</sqlCheck>
			</and>
		</preConditions>
		<comment>Insert PUI nametype into udflds table - using fldno 40 if it is not yet existing</comment>
		<sql dbms="mysql" splitStatements="false">
			INSERT INTO udflds (fldno, ftable, ftype, fcode, fname, ffmt, fdesc, lfldno, fuid, fdate, scaleid)
			VALUES (40, 'NAMES', 'NAME', 'PUI', 'PERMANENT UNIQUE IDENTIFIER', '-', 'The Permanent Unique Identifier which represents a germplasm
				MCPD (v2.1) Any persistent, unique identifier assigned to the accession so it can be unambiguously referenced at the global level and the information associated with it.', 0, 0, 20210701, 0);
		</sql>
	</changeSet>

	<changeSet author="darla" id="v18.4.0-2">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(1) FROM udflds where ftable = 'NAMES' AND ftype = 'NAME' and fcode = 'PUI';
			</sqlCheck>
		</preConditions>
		<comment>Insert PUI nametype into udflds table - using next available fldno meaning fldno 40 was taken</comment>
		<sql dbms="mysql" splitStatements="false">
			INSERT INTO udflds (ftable, ftype, fcode, fname, ffmt, fdesc, lfldno, fuid, fdate, scaleid)
			VALUES ('NAMES', 'NAME', 'PUI', 'PERMANENT UNIQUE IDENTIFIER', '-', 'The Permanent Unique Identifier which represents a germplasm
				MCPD (v2.1) Any persistent, unique identifier assigned to the accession so it can be unambiguously referenced at the global level and the information associated with it.', 0, 0, 20210701, 0);
		</sql>
	</changeSet>

	<changeSet author="mderamos" id="v18.4.0-3">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="external_reference_sample"/>
			</not>
		</preConditions>
		<comment>
			Create external_reference_sample table
		</comment>
		<createTable tableName="external_reference_sample">
			<column name="id" type="int" autoIncrement="true">
				<constraints primaryKey="true"/>
			</column>
			<column name="sample_id" type="int">
				<constraints nullable="false" foreignKeyName="fk_external_reference_sample" references="sample(sample_id)"/>
			</column>
			<column name="reference_id" type="varchar(2000)">
				<constraints nullable="false"/>
			</column>
			<column name="reference_source" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="created_date" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
				<constraints nullable="false"/>
			</column>
			<column name="created_by" type="int" defaultValue="0">
				<constraints nullable="false" />
			</column>
			<column name="modified_date" type="timestamp">
				<constraints nullable="true"/>
			</column>
			<column name="modified_by" type="int">
				<constraints nullable="true" />
			</column>
		</createTable>
	</changeSet>

	<changeSet author="darla" id="v18.4.0-4">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="1">
					SELECT 1 FROM CVTERM_RELATIONSHIP WHERE SUBJECT_ID = 6015 AND TYPE_ID = 1105;
				</sqlCheck>
				<sqlCheck expectedResult="0">
					SELECT COUNT(1) FROM CVTERM_RELATIONSHIP WHERE SUBJECT_ID = 6015 AND TYPE_ID = 1105 AND OBJECT_ID = 1136;
				</sqlCheck>
			</and>
		</preConditions>
		<comment>Update data type of BMETH_CODE (cvterm ID: 6015) to Breeding Method (cvterm ID: 1136)</comment>
		<sql dbms="mysql" splitStatements="false">
			UPDATE CVTERM_RELATIONSHIP SET OBJECT_ID = 1136 WHERE SUBJECT_ID = 6015 AND TYPE_ID = 1105;
		</sql>
	</changeSet>

	<changeSet author="darla" id="v18.4.0-5">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="1">
					SELECT 1 FROM CVTERM_RELATIONSHIP WHERE SUBJECT_ID = 6016 AND TYPE_ID = 1105;
				</sqlCheck>
				<sqlCheck expectedResult="0">
					SELECT COUNT(1) FROM CVTERM_RELATIONSHIP WHERE SUBJECT_ID = 6016 AND TYPE_ID = 1105 AND OBJECT_ID = 1132;
				</sqlCheck>
			</and>
		</preConditions>
		<comment>Update data type of LOC_ABBR (cvterm ID: 6016) to Location (cvterm ID: 1132)</comment>
		<sql dbms="mysql" splitStatements="false">
			UPDATE CVTERM_RELATIONSHIP SET OBJECT_ID = 1132 WHERE SUBJECT_ID = 6016 AND TYPE_ID = 1105;
		</sql>
	</changeSet>

	<changeSet author="darla" id="v18.4.0-6">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 1911;</sqlCheck>
		</preConditions>
		<comment>Create "Contact Person Name" scale with character data type</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (1911, 1030, 'Contact Person Name', 'Name of contact person associated with incoming study', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES (1105, 1911, 1120);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-7">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 1912;</sqlCheck>
		</preConditions>
		<comment>Create "Contact Person Email" scale with character data type</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (1912, 1030, 'Contact Person Email', 'Email of contact person associated with incoming study', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES (1105, 1912, 1120);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-8">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 1913;</sqlCheck>
		</preConditions>
		<comment>Create "Contact Person Organization" scale with character data type</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (1913, 1030, 'Contact Person Organization', 'Organization of contact person associated with incoming study', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES (1105, 1913, 1120);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-9">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 1914;</sqlCheck>
		</preConditions>
		<comment>Create "Contact Person Type" scale with character data type</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (1914, 1030, 'Contact Person Type', 'Type of contact person associated with incoming study', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES (1105, 1914, 1120);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-10">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 8116;</sqlCheck>
				<sqlCheck expectedResult="1">select count(*) from cvterm where cvterm_id = 1911;</sqlCheck>
			</and>
		</preConditions>
		<comment>Create "CONTACT_NAME" variable</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (8116, 1040, 'CONTACT_NAME', 'Contact Person Name', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES
			(1200, 8116, 2080),
			(1210, 8116, 4030),
			(1220, 8116, 1911);

			INSERT INTO cvtermprop(cvterm_id, type_id, value, rank)
			VALUES
			(8116, 1800, 'Study Detail', 0),
			(8116, 1800, 'Environment Detail', 1);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-11">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 8117;</sqlCheck>
				<sqlCheck expectedResult="1">select count(*) from cvterm where cvterm_id = 1912;</sqlCheck>
			</and>
		</preConditions>
		<comment>Create "CONTACT_EMAIL" variable</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (8117, 1040, 'CONTACT_EMAIL', 'Contact Person Email', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES
			(1200, 8117, 2080),
			(1210, 8117, 4030),
			(1220, 8117, 1912);

			INSERT INTO cvtermprop(cvterm_id, type_id, value, rank)
			VALUES
			(8117, 1800,'Study Detail', 0),
			(8117, 1800, 'Environment Detail', 1);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-12">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 8118;</sqlCheck>
				<sqlCheck expectedResult="1">select count(*) from cvterm where cvterm_id = 1913;</sqlCheck>
			</and>
		</preConditions>
		<comment>Create "CONTACT_ORG" variable</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (8118, 1040, 'CONTACT_ORG', 'Contact Person Organization', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES
			(1200, 8118, 2080),
			(1210, 8118, 4030),
			(1220, 8118, 1913);

			INSERT INTO cvtermprop(cvterm_id, type_id, value, rank)
			VALUES
			(8118, 1800,'Study Detail', 0),
			(8118, 1800, 'Environment Detail', 1);
        </sql>
    </changeSet>

	<changeSet author="darla" id="v18.4.0-13">
		<preConditions onFail="MARK_RAN">
			<and>
				<sqlCheck expectedResult="0">select count(*) from cvterm where cvterm_id = 8119;</sqlCheck>
				<sqlCheck expectedResult="1">select count(*) from cvterm where cvterm_id = 1914;</sqlCheck>
			</and>
		</preConditions>
		<comment>Create "CONTACT_TYPE" variable</comment>
        <sql dbms="mysql" splitStatements="true">
			INSERT INTO cvterm (cvterm_id, cv_id, name, definition, dbxref_id, is_obsolete, is_relationshiptype)
			VALUES (8119, 1040, 'CONTACT_TYPE', 'Contact Person Type', null, 0, 0);

			INSERT INTO cvterm_relationship(type_id, subject_id, object_id)
			VALUES
			(1200, 8119, 2080),
			(1210, 8119, 4030),
			(1220, 8119, 1914);

			INSERT INTO cvtermprop(cvterm_id, type_id, value, rank)
			VALUES
			(8119, 1800,'Study Detail', 0),
			(8119, 1800, 'Environment Detail', 1);
        </sql>
    </changeSet>


</databaseChangeLog>
