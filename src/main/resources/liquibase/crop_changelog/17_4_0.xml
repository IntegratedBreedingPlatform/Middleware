<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="gelli" id="v17.4.0-1">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(1) FROM cvterm WHERE cvterm_id = 10185
            </sqlCheck>
        </preConditions>
        <comment>
            Create entry_type X-Non Replicated if not exists, else create entry_type XRP-Non Replicated.
        </comment>
        <sql>
            INSERT INTO cvterm (name, cvterm_id, cv_id, definition, dbxref_id, is_obsolete, is_relationshiptype)
            (SELECT CASE
                    WHEN (SELECT COUNT(1) FROM cvterm WHERE name = 'X' AND cv_id = 2050 AND is_obsolete = 0) > 0 THEN 'XRP'
                    ELSE 'X'
                END,
            10185,2050,'Non Replicated',NULL,0,0);
        </sql>
    </changeSet>

    <changeSet author="gelli" id="v17.4.0-2">
        <preConditions onFail="MARK_RAN">
            <and>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(1) FROM cvterm_relationship WHERE object_id = 10185 AND
                    type_id = (SELECT cvterm_id FROM cvterm WHERE name = 'has value' AND cv_id = 1000 AND is_obsolete = 0) AND
                    subject_id = (SELECT cvterm_id FROM cvterm WHERE name = 'Type of ENTRY_TYPE' AND cv_id = 1030 AND is_obsolete = 0);
                </sqlCheck>
                <sqlCheck expectedResult="1">
                    SELECT COUNT(1) FROM cvterm WHERE cvterm_id = 10185;
                </sqlCheck>
                <sqlCheck expectedResult="1">
                    SELECT COUNT(1) FROM cvterm WHERE name = 'has value' AND cv_id = 1000 AND is_obsolete = 0;
                </sqlCheck>
                <sqlCheck expectedResult="1">
                    SELECT COUNT(1) FROM cvterm WHERE name = 'Type of ENTRY_TYPE' AND cv_id = 1030 AND is_obsolete = 0;
                </sqlCheck>
            </and>
        </preConditions>
        <comment>
            Create cvterm_relationship for Non Replicated. Value of Type of ENTRY_TYPE.
            Cvterms 'has value' and 'Type of ENTRY_TYPE' are fetched by names, cv_id, is_obsolete (which is unique) to make sure
            cvterm_relationship is using the correct cvterm_id.
        </comment>
        <sql>
            INSERT INTO cvterm_relationship (type_id, subject_id, object_id)
            VALUES (
            (SELECT cvterm_id FROM cvterm WHERE name = 'has value' AND cv_id = 1000 AND is_obsolete = 0),
            (SELECT cvterm_id FROM cvterm WHERE name = 'Type of ENTRY_TYPE' AND cv_id = 1030 AND is_obsolete = 0),
            10185);
        </sql>
    </changeSet>

</databaseChangeLog>
