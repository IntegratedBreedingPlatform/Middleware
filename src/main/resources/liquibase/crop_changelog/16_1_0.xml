<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="medramos" id="v16.1.0-1">
		<preConditions onFail="MARK_RAN">
			<not>
				<columnExists tableName="germplsm" columnName="germplsm_uuid"/>
			</not>
		</preConditions>
		<comment>
			Add guid column to germplsm table
		</comment>
		<addColumn tableName="germplsm">
			<column name="germplsm_uuid" type="VARCHAR(36)">
				<constraints nullable="true"/>
			</column>
		</addColumn>
	</changeSet>

	<changeSet author="mderamos" id="v16.1.0-2">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT
				COUNT(*)
				FROM
				information_schema.routines
				WHERE
				routine_schema = DATABASE()
				AND specific_name = 'populate_germplsm_uuid_values';
			</sqlCheck>
		</preConditions>
		<sql dbms="mysql" splitStatements="false">
			DROP PROCEDURE populate_germplsm_uuid_values;
		</sql>
	</changeSet>

	<changeSet author="mderamos" id="v16.1.0-3">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT
				COUNT(*)
				FROM
				information_schema.routines
				WHERE
				routine_schema = DATABASE()
				AND specific_name = 'populate_germplsm_uuid_values';
			</sqlCheck>
		</preConditions>
		<comment>
			Create Stored procedure that populate the germplsm_uuid values
		</comment>
		<sql dbms="mysql" splitStatements="false">
			CREATE PROCEDURE populate_germplsm_uuid_values()
			BEGIN

			DECLARE useUuid INT DEFAULT 1;
			DECLARE hasNullUuidCount INT DEFAULT 1;
			DECLARE duplicates INT DEFAULT 1;

			SELECT use_uuid
			INTO useUuid
			FROM workbench.workbench_crop
			WHERE db_name = DATABASE();

			IF useUuid = 0	THEN

			WHILE(hasNullUuidCount > 0) DO

			UPDATE germplsm g
			SET germplsm_uuid = CONCAT((SELECT plot_code_prefix
			FROM workbench.workbench_crop wc
			WHERE db_name = DATABASE()),
			'G',
			RIGHT(sha1(CONCAT(uuid(), g.gid)), 31))
			WHERE g.germplsm_uuid IS NULL;

			SELECT sum(c)
			into duplicates
			FROM (SELECT count(1) c
			FROM germplsm
			WHERE germplsm_uuid IS NOT NULL
			GROUP BY germplsm_uuid
			HAVING count(1) >= 2) T;

			IF duplicates > 0 THEN

			UPDATE germplsm
			SET germplsm_uuid = NULL
			WHERE gid IN (
			SELECT gid
			FROM (
			SELECT g1.gid
			FROM germplsm g1
			WHERE EXISTS
			(
			SELECT 1
			FROM germplsm g2
			WHERE g1.germplsm_uuid = g2.germplsm_uuid
			LIMIT 1, 1
			) AND g1.germplsm_uuid IS NOT NULL) AS G);

			END IF;

			SELECT count(*) into hasNullUuidCount
			FROM germplsm where germplsm_uuid IS NULL;

			END WHILE;


			ELSE

			UPDATE germplsm g
			SET germplsm_uuid = uuid()
			WHERE g.germplsm_uuid IS NULL;

			END IF;

			END;
		</sql>
	</changeSet>

	<changeSet author="mderamos" id="v16.1.0-4">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT
				COUNT(*)
				FROM
				information_schema.routines
				WHERE
				routine_schema = DATABASE()
				AND specific_name = 'populate_germplsm_uuid_values';
			</sqlCheck>
		</preConditions>
		<sql dbms="mysql" splitStatements="false">
			call populate_germplsm_uuid_values();
		</sql>
	</changeSet>

	<changeSet author="mderamos" id="v16.1.0-5">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="1">
				SELECT
				COUNT(*)
				FROM
				information_schema.routines
				WHERE
				routine_schema = DATABASE()
				AND specific_name = 'populate_germplsm_uuid_values';
			</sqlCheck>
		</preConditions>
		<sql dbms="mysql" splitStatements="false">
			DROP PROCEDURE populate_germplsm_uuid_values;
		</sql>
	</changeSet>

	<changeSet author="mderamos" id="v16.1.0-6">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">SELECT count(*) FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE TABLE_NAME = 'germplsm' AND CONSTRAINT_NAME='germplsm_uuid_unique' and TABLE_SCHEMA = DATABASE();</sqlCheck>
		</preConditions>
		<addUniqueConstraint tableName="germplsm" columnNames="germplsm_uuid" constraintName="germplsm_uuid_unique"/>
	</changeSet>

</databaseChangeLog>
