<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<changeSet author="lkovacic" id="v17.2.0-1">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM permission WHERE
					(name = 'MG_MANAGE_INVENTORY' AND parent_id =
					(SELECT permission_id FROM permission WHERE name = 'MANAGE_GERMPLASM'))
					OR (name IN ('MG_MANAGE_INVENTORY', 'MG_CREATE_LOTS') AND workbench_sidebar_category_link_id IS NULL);
            </sqlCheck>
        </preConditions>
        <comment>Update MG_MANAGE_INVENTORY permission</comment>
		<sql dbms="mysql" splitStatements="true">
				UPDATE permission
				SET parent_id = (SELECT p1.permission_id
								 FROM (SELECT permission_id
									   FROM permission
									   WHERE name = 'MANAGE_GERMPLASM') AS p1)
				WHERE name = 'MG_MANAGE_INVENTORY';

				UPDATE permission
				SET workbench_sidebar_category_link_id = NULL
				WHERE name IN ('MG_MANAGE_INVENTORY', 'MG_CREATE_LOTS');
		</sql>
	</changeSet>

</databaseChangeLog>
