<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
	<changeSet author="cuenyad" id="v23.2.0-1">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'CREATE_STUDIES';
             </sqlCheck>
 		</preConditions>
         <comment>Create Studies permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @mg_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'MANAGE_STUDIES');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('CREATE_STUDIES', 'Create Studies', @mg_studies_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'CREATE_STUDIES');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-2">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'CLOSE_STUDY';
             </sqlCheck>
 		</preConditions>
         <comment>Close Study permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @mg_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'MANAGE_STUDIES');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('CLOSE_STUDY', 'Close Study', @mg_studies_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'CLOSE_STUDY');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-3">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'DELETE_STUDY';
             </sqlCheck>
 		</preConditions>
         <comment>Delete Study permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @mg_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'MANAGE_STUDIES');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('DELETE_STUDY', 'Delete Study', @mg_studies_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'DELETE_STUDY');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-4">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'LOCK_STUDY';
             </sqlCheck>
 		</preConditions>
         <comment>Lock Study permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @mg_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'MANAGE_STUDIES');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('LOCK_STUDY', 'Lock Study', @mg_studies_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'LOCK_STUDY');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-5">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'GERMPLASM_AND_CHECKS';
             </sqlCheck>
 		</preConditions>
         <comment>Germplasm and Checks permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @mg_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'MANAGE_STUDIES');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('GERMPLASM_AND_CHECKS', 'Germplasm and Checks', @mg_studies_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-6">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'VIEW_GERMPLASM_AND_CHECKS';
             </sqlCheck>
 		</preConditions>
         <comment>View Germplasm and Checks permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('VIEW_GERMPLASM_AND_CHECKS', 'View Germplasm and Checks', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'VIEW_GERMPLASM_AND_CHECKS');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-7">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'ADD_ENTRY_DETAILS_VARIABLES';
             </sqlCheck>
 		</preConditions>
         <comment>Add Entry Details Variables permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('ADD_ENTRY_DETAILS_VARIABLES', 'Add Entry Details Variables', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'ADD_ENTRY_DETAILS_VARIABLES');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-8">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'ADD_ENTRY_DETAILS_VALUES';
             </sqlCheck>
 		</preConditions>
         <comment>Add Entry Details Values permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('ADD_ENTRY_DETAILS_VALUES', 'Add Entry Details Values', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'ADD_ENTRY_DETAILS_VALUES');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-9">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'MODIFY_COLUMNS_GERMPLASM_AND_CHECKS';
             </sqlCheck>
 		</preConditions>
         <comment>Modify Columns permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('MODIFY_COLUMNS', 'Modify Columns', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'MODIFY_COLUMNS');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-10">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'REPLACE_GERMPLASM';
             </sqlCheck>
 		</preConditions>
         <comment>Replace Germplasm permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('REPLACE_GERMPLASM', 'Replace Germplasm', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'REPLACE_GERMPLASM');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-11">
         <preConditions onFail="MARK_RAN">
 			<sqlCheck expectedResult="0">
                 SELECT COUNT(*) FROM PERMISSION P WHERE P.NAME = 'ADD_NEW_ENTRIES';
             </sqlCheck>
 		</preConditions>
         <comment>Add New Entries permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			INSERT INTO permission (`name`, `description`, `parent_id`) VALUES ('ADD_NEW_ENTRIES', 'Add New Entries', @germplasm_and_checks_permission_id);

			SET @permission_id = (SELECT permission_id FROM permission WHERE name = 'ADD_NEW_ENTRIES');

			insert into role_type_permission(role_type_id, permission_id, selectable) values (1, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (2, @permission_id , 1);
			insert into role_type_permission(role_type_id, permission_id, selectable) values (3, @permission_id , 1);
 		</sql>
 	</changeSet>

	<changeSet author="cuenyad" id="v23.2.0-12">
         <preConditions onFail="MARK_RAN">
			<and>
            	<sqlCheck expectedResult="0">
                	SELECT count(*) > 1 FROM role_permission rp INNER JOIN permission p ON rp.permission_id = p.permission_id
					WHERE p.name IN ('CREATE_STUDIES', 'CLOSE_STUDY', 'DELETE_STUDY', 'LOCK_STUDY', 'GERMPLASM_AND_CHECKS');
            	</sqlCheck>
				<not>
					<tableExists tableName="roles_affected_temporary"></tableExists>
				</not>
			</and>
 		</preConditions>
         <comment>Adding new granular studies permissions in role_permission</comment>
 		<sql dbms="mysql" splitStatements="true">
			SET @create_studies_permission_id = (SELECT permission_id FROM permission WHERE name = 'CREATE_STUDIES');
			SET @close_study_permission_id = (SELECT permission_id FROM permission WHERE name = 'CLOSE_STUDY');
			SET @delete_study_permission_id = (SELECT permission_id FROM permission WHERE name = 'DELETE_STUDY');
			SET @lock_study_permission_id = (SELECT permission_id FROM permission WHERE name = 'LOCK_STUDY');
			SET @germplasm_and_checks_permission_id = (SELECT permission_id FROM permission WHERE name = 'GERMPLASM_AND_CHECKS');

			#Create roles_affected_temporary Table
			CREATE TEMPORARY TABLE roles_affected_temporary (
				role_id int(11) not null
			);

			#Insert role id in Temporary table
			INSERT INTO roles_affected_temporary (role_id)
			SELECT DISTINCT(rp.role_id) FROM role_permission rp INNER JOIN  permission p ON rp.permission_id = p.permission_id
			WHERE p.name IN ('MS_MANAGE_OBSERVATION_UNITS','MS_WITHDRAW_INVENTORY',
							 'MS_CREATE_PENDING_WITHDRAWALS','MS_CREATE_CONFIRMED_WITHDRAWALS',
							 'MS_CANCEL_PENDING_TRANSACTIONS','MS_MANAGE_FILES','MS_CREATE_LOTS')
			GROUP BY rp.role_id;

			#Insert permissions in role_permission
			INSERT INTO role_permission(role_id, permission_id)
			SELECT rp.role_id, @create_studies_permission_id FROM roles_affected_temporary rp;

			INSERT INTO role_permission(role_id, permission_id)
			SELECT rp.role_id, @close_study_permission_id FROM roles_affected_temporary rp;

			INSERT INTO role_permission(role_id, permission_id)
			SELECT rp.role_id, @delete_study_permission_id FROM roles_affected_temporary rp;

			INSERT INTO role_permission(role_id, permission_id)
			SELECT rp.role_id, @lock_study_permission_id FROM roles_affected_temporary rp;

			INSERT INTO role_permission(role_id, permission_id)
			SELECT rp.role_id, @germplasm_and_checks_permission_id FROM roles_affected_temporary rp;

			#Delete roles_affected_temporary Table
			DROP TABLE roles_affected_temporary;

 		</sql>
 	</changeSet>
</databaseChangeLog>
