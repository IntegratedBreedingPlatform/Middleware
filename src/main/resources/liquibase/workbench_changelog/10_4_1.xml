<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
				   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
		http://www.liquibase.org/xml/ns/dbchangelog-ext
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	
	<changeSet author="marie" id="v10.4.1-1">
        <preConditions onFail="MARK_RAN">
	            <sqlCheck expectedResult="1">
	               SELECT count(*) FROM workbench_sidebar_category_link WHERE tool_name = 'trait_donor_query';
	            </sqlCheck>
        </preConditions>
        <comment>Change Trait Donor Query label to Weighted Multi-trait Query in sidebar menu</comment>
        <sql dbms="mysql" splitStatements="true">
            UPDATE workbench_sidebar_category_link SET sidebar_link_title = 'Weighted Multi-trait Query' WHERE tool_name = 'trait_donor_query';
        </sql>
    </changeSet>

	<changeSet author="mderamos" id="v10.4.1-2">
        <preConditions onFail="MARK_RAN">
			<not>
				<sqlCheck expectedResult="0">
					SELECT count(*) FROM workbench_ibdb_user_map WHERE NOT EXISTS
						(SELECT * FROM workbench_project_user_info WHERE
							project_id = workbench_ibdb_user_map.project_id
							AND user_id = workbench_ibdb_user_map.workbench_user_id)
				</sqlCheck>
			</not>
        </preConditions>
        <comment>Clean up workbench_ibdb_user_map table, delete the removed users from a program</comment>
        <sql dbms="mysql" splitStatements="true">
			DELETE FROM workbench_ibdb_user_map WHERE NOT EXISTS
				(SELECT * FROM workbench_project_user_info WHERE
					project_id = workbench_ibdb_user_map.project_id
					AND user_id = workbench_ibdb_user_map.workbench_user_id)
        </sql>
    </changeSet>

</databaseChangeLog>
